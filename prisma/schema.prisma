// VexiumVerse Database Schema
// Configured for Supabase PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
}

// ============================================
// AUTH MODELS (NextAuth.js)
// ============================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  discordId     String?   @unique
  
  // Global reputation across all worlds
  globalReputation Int @default(0)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accounts  Account[]
  sessions  Session[]
  citizens  Citizen[]
  ownedWorlds World[]   @relation("WorldOwner")
}

// ============================================
// WORLD / ECONOMY MODELS
// ============================================

model World {
  id          String @id @default(cuid())
  name        String
  description String?
  discordServerId String @unique
  
  // Currency settings
  currencyName   String @default("Credits")
  currencySymbol String @default("Â©")
  
  // Tax rates (as percentages, e.g., 5 = 5%)
  salesTaxRate      Float @default(5)
  incomeTaxRate     Float @default(10)
  propertyTaxRate   Float @default(2)
  
  // Economic settings
  initialCitizenBalance Float @default(1000)
  decayInterval         Int   @default(24) // Hours between decay ticks
  
  // Status
  isActive  Boolean @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Owner
  ownerId String
  owner   User @relation("WorldOwner", fields: [ownerId], references: [id])
  
  // Relations
  regions     Region[]
  citizens    Citizen[]
  businesses  Business[]
  treasury    Treasury?
  transactions Transaction[]
  resources   ResourceDeposit[]
  loans       Loan[]
  invoices    Invoice[]
}

model Region {
  id          String @id @default(cuid())
  name        String
  description String?
  
  // Regional settings
  permitPrice    Float @default(100)
  landPrice      Float @default(500)
  
  // Status
  isActive  Boolean @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // World relation
  worldId String
  world   World @relation(fields: [worldId], references: [id], onDelete: Cascade)
  
  // Mayor (optional - can be elected or appointed)
  mayorId String?
  mayor   Citizen? @relation("RegionMayor", fields: [mayorId], references: [id])
  
  // Relations
  businesses Business[]
  resourceDeposits ResourceDeposit[]
  regionTreasury RegionTreasury?
}

// ============================================
// RESOURCE MODELS
// ============================================

model Resource {
  id          String @id @default(cuid())
  name        String @unique // Oil, Wood, Metal, Gold, etc.
  description String?
  category    ResourceCategory
  baseValue   Float @default(10)
  
  // Relations
  deposits ResourceDeposit[]
  inventoryItems InventoryItem[]
  productionInputs ProductionInput[]
  productionOutputs ProductionOutput[]
}

enum ResourceCategory {
  RAW_MATERIAL  // Oil, Wood, Metal, Gold
  PROCESSED     // Fuel, Lumber, Steel
  CONSUMABLE    // Food, Water
  MANUFACTURED  // Vehicles, Machinery
  SERVICE       // Labor, Transport
}

model ResourceDeposit {
  id String @id @default(cuid())
  
  // Finite resources
  totalCapacity   Float // Total extractable units
  remainingAmount Float // Current remaining
  extractionRate  Float @default(10) // Max units per cycle
  
  // Status
  isActive  Boolean @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  worldId    String
  world      World @relation(fields: [worldId], references: [id], onDelete: Cascade)
  regionId   String
  region     Region @relation(fields: [regionId], references: [id], onDelete: Cascade)
  resourceId String
  resource   Resource @relation(fields: [resourceId], references: [id])
  
  // Business extracting this deposit
  extractorId String?
  extractor   Business? @relation("ResourceExtractor", fields: [extractorId], references: [id])
}

// ============================================
// ACTOR MODELS
// ============================================

model Citizen {
  id String @id @default(cuid())
  
  // Identity
  displayName String
  
  // Economic status
  walletBalance  Float @default(0)
  bankBalance    Float @default(0)
  
  // Status
  isActive  Boolean @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // User relation (one user can be citizen in multiple worlds)
  userId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // World relation
  worldId String
  world   World @relation(fields: [worldId], references: [id], onDelete: Cascade)
  
  // Relations
  survivalNeeds   SurvivalNeeds?
  ownedBusinesses Business[]      @relation("BusinessOwner")
  employments     Employee[]
  inventory       InventoryItem[]
  
  // Regional governance
  mayorOfRegions Region[] @relation("RegionMayor")
  
  // Transactions
  sentTransactions     Transaction[] @relation("TransactionSender")
  receivedTransactions Transaction[] @relation("TransactionReceiver")
  
  // Loans
  loans Loan[]
  
  // Invoices
  sentInvoices     Invoice[] @relation("InvoiceSender")
  receivedInvoices Invoice[] @relation("InvoiceReceiver")

  @@unique([userId, worldId])
}

model SurvivalNeeds {
  id String @id @default(cuid())
  
  // Needs (0-100 scale)
  food  Float @default(100)
  water Float @default(100)
  sleep Float @default(100)
  
  // Last decay timestamp
  lastDecayAt DateTime @default(now())
  
  // Citizen relation
  citizenId String @unique
  citizen   Citizen @relation(fields: [citizenId], references: [id], onDelete: Cascade)
}

model Business {
  id          String @id @default(cuid())
  name        String
  description String?
  type        BusinessType
  
  // Economic settings
  operatingCost Float @default(0) // Daily operating cost
  productionCapacity Int @default(10) // Units per cycle
  
  // Financial status
  walletBalance Float @default(0)
  
  // Status
  isActive  Boolean @default(true)
  isOperating Boolean @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Owner
  ownerId String
  owner   Citizen @relation("BusinessOwner", fields: [ownerId], references: [id])
  
  // Location
  worldId  String
  world    World @relation(fields: [worldId], references: [id], onDelete: Cascade)
  regionId String
  region   Region @relation(fields: [regionId], references: [id])
  
  // Relations
  employees     Employee[]
  inventory     InventoryItem[]
  extracting    ResourceDeposit[] @relation("ResourceExtractor")
  
  // Production
  productionInputs  ProductionInput[]
  productionOutputs ProductionOutput[]
  
  // Transactions
  sentTransactions     Transaction[] @relation("BusinessSender")
  receivedTransactions Transaction[] @relation("BusinessReceiver")
  
  // Invoices
  sentInvoices     Invoice[] @relation("BusinessInvoiceSender")
  receivedInvoices Invoice[] @relation("BusinessInvoiceReceiver")
}

enum BusinessType {
  // Survival & Utilities
  WATER_PURIFICATION
  FARM
  GROCERY_STORE
  
  // Resource Extraction
  MINING
  OIL_DRILLING
  LOGGING
  
  // Processing
  OIL_REFINERY
  STEEL_MILL
  MACHINERY_MANUFACTURING
  FOOD_PROCESSING
  
  // Logistics & Mobility
  TRUCKING_COMPANY
  VEHICLE_DEALERSHIP
  GAS_STATION
  
  // Infrastructure
  BUSINESS_CONSTRUCTION
  REAL_ESTATE_CONSTRUCTION
}

model Employee {
  id String @id @default(cuid())
  
  // Employment details
  position   String
  hourlyWage Float
  hoursWorked Float @default(0)
  
  // Status
  isActive  Boolean @default(true)
  hiredAt   DateTime @default(now())
  
  // Relations
  citizenId  String
  citizen    Citizen @relation(fields: [citizenId], references: [id], onDelete: Cascade)
  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([citizenId, businessId])
}

// ============================================
// INVENTORY & PRODUCTION MODELS
// ============================================

model InventoryItem {
  id String @id @default(cuid())
  
  quantity Float
  
  // Relations
  resourceId String
  resource   Resource @relation(fields: [resourceId], references: [id])
  
  // Owner (either citizen or business, not both)
  citizenId  String?
  citizen    Citizen? @relation(fields: [citizenId], references: [id], onDelete: Cascade)
  businessId String?
  business   Business? @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  @@unique([resourceId, citizenId])
  @@unique([resourceId, businessId])
}

model ProductionInput {
  id String @id @default(cuid())
  
  // Required quantity per production cycle
  quantity Float
  
  // Relations
  resourceId String
  resource   Resource @relation(fields: [resourceId], references: [id])
  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([resourceId, businessId])
}

model ProductionOutput {
  id String @id @default(cuid())
  
  // Produced quantity per production cycle
  quantity Float
  
  // Relations
  resourceId String
  resource   Resource @relation(fields: [resourceId], references: [id])
  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([resourceId, businessId])
}

// ============================================
// TREASURY & FINANCIAL MODELS
// ============================================

model Treasury {
  id String @id @default(cuid())
  
  balance Float @default(0)
  
  // Revenue tracking
  totalTaxRevenue   Float @default(0)
  totalPermitRevenue Float @default(0)
  totalLandRevenue  Float @default(0)
  
  // Spending tracking
  totalSubsidies    Float @default(0)
  totalLoansIssued  Float @default(0)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // World relation (one treasury per world)
  worldId String @unique
  world   World @relation(fields: [worldId], references: [id], onDelete: Cascade)
}

model RegionTreasury {
  id String @id @default(cuid())
  
  balance Float @default(0)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Region relation (one treasury per region)
  regionId String @unique
  region   Region @relation(fields: [regionId], references: [id], onDelete: Cascade)
}

model Transaction {
  id String @id @default(cuid())
  
  amount      Float
  type        TransactionType
  description String?
  
  // Tax applied (if any)
  taxAmount Float @default(0)
  
  // Status
  status    TransactionStatus @default(COMPLETED)
  createdAt DateTime @default(now())
  
  // World context
  worldId String
  world   World @relation(fields: [worldId], references: [id], onDelete: Cascade)
  
  // Sender (one of these)
  senderCitizenId  String?
  senderCitizen    Citizen? @relation("TransactionSender", fields: [senderCitizenId], references: [id])
  senderBusinessId String?
  senderBusiness   Business? @relation("BusinessSender", fields: [senderBusinessId], references: [id])
  
  // Receiver (one of these)
  receiverCitizenId  String?
  receiverCitizen    Citizen? @relation("TransactionReceiver", fields: [receiverCitizenId], references: [id])
  receiverBusinessId String?
  receiverBusiness   Business? @relation("BusinessReceiver", fields: [receiverBusinessId], references: [id])
  
  // Invoice reference (if payment for invoice)
  invoiceId String?
  invoice   Invoice? @relation(fields: [invoiceId], references: [id])
}

enum TransactionType {
  TRANSFER       // Direct transfer between parties
  PAYMENT        // Payment for goods/services
  TAX            // Tax payment to treasury
  SALARY         // Wage payment
  LOAN_DISBURSEMENT
  LOAN_REPAYMENT
  TREASURY_SUBSIDY
  PERMIT_PURCHASE
  LAND_PURCHASE
  RESOURCE_EXTRACTION
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

// Transaction Intent - for Discord bot initiated transactions
model TransactionIntent {
  id          String   @id @default(cuid())
  token       String   @unique @default(cuid())  // URL-safe token for confirmation link
  
  amount      Float
  type        TransactionType
  description String?
  
  // Sender
  senderType  EntityType
  senderId    String
  
  // Receiver
  receiverType EntityType
  receiverId   String
  
  // World context
  worldId     String
  
  // Status tracking
  status      IntentStatus @default(PENDING)
  expiresAt   DateTime     // Intent expiration time
  createdAt   DateTime     @default(now())
  completedAt DateTime?
  
  // Result (set after execution)
  transactionId String?
  errorMessage  String?
}

enum EntityType {
  CITIZEN
  BUSINESS
  TREASURY
}

enum IntentStatus {
  PENDING
  CONFIRMED
  EXECUTED
  EXPIRED
  CANCELLED
}

model Loan {
  id String @id @default(cuid())
  
  principalAmount Float
  interestRate    Float // Annual percentage
  termMonths      Int
  
  // Tracking
  amountPaid      Float @default(0)
  nextPaymentDue  DateTime?
  
  // Status
  status    LoanStatus @default(ACTIVE)
  issuedAt  DateTime @default(now())
  
  // Relations
  worldId   String
  world     World @relation(fields: [worldId], references: [id], onDelete: Cascade)
  borrowerId String
  borrower   Citizen @relation(fields: [borrowerId], references: [id])
}

enum LoanStatus {
  PENDING
  ACTIVE
  PAID_OFF
  DEFAULTED
}

model Invoice {
  id String @id @default(cuid())
  
  amount      Float
  description String
  dueDate     DateTime?
  
  // Status
  status    InvoiceStatus @default(PENDING)
  createdAt DateTime @default(now())
  paidAt    DateTime?
  
  // World context
  worldId String
  world   World @relation(fields: [worldId], references: [id], onDelete: Cascade)
  
  // Sender (citizen or business)
  senderCitizenId  String?
  senderCitizen    Citizen? @relation("InvoiceSender", fields: [senderCitizenId], references: [id])
  senderBusinessId String?
  senderBusiness   Business? @relation("BusinessInvoiceSender", fields: [senderBusinessId], references: [id])
  
  // Receiver (citizen or business)
  receiverCitizenId  String?
  receiverCitizen    Citizen? @relation("InvoiceReceiver", fields: [receiverCitizenId], references: [id])
  receiverBusinessId String?
  receiverBusiness   Business? @relation("BusinessInvoiceReceiver", fields: [receiverBusinessId], references: [id])
  
  // Payment transactions
  payments Transaction[]
}

enum InvoiceStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
}

// ============================================
// SYSTEM EVENTS
// ============================================

model DecayEvent {
  id String @id @default(cuid())
  
  type       DecayEventType
  targetId   String // ID of affected entity
  oldValue   Float
  newValue   Float
  
  processedAt DateTime @default(now())
}

enum DecayEventType {
  SURVIVAL_FOOD
  SURVIVAL_WATER
  SURVIVAL_SLEEP
  RESOURCE_DEPLETION
  INACTIVITY_PENALTY
}
